---
typora-root-url: ./..\..\public
---


# 分配策略

## 6.1 你把东西放在磁盘的什么位置？

Be文件系统将磁盘视为一个块数组。这些块从零开始编号，一直到设备的 最大磁盘块。从文件系统的角度来看，这种存储设备视图简单且易于操作。 但物理磁盘的几何结构不仅仅是简单的磁盘块数组。文件系统用来安排数据 在磁盘上位置的策略，会对文件系统的整体性能产生重大影响。本章解释了 什么是分配策略、如何在磁盘上安排数据的不同方式，以及利用磁盘物理特性 提高文件系统吞吐量的其他机制。

## 6.2 什么是分配策略？

分配策略是文件系统用于决定将项目放置在磁盘何处的规则和启发法集合。 分配策略决定了文件系统元数据（i-node、目录数据和索引）以及文件数据的 位置。用于此任务的规则从简单到复杂不等。幸运的是，一套规则的有效性并 不总是与复杂性相匹配。

分配策略的目标是安排数据在磁盘上的布局，以便在以后检索数据时提供 尽可能最佳的吞吐量。有几个因素影响分配策略的成功。定义良好分配策略 的一个关键因素是了解磁盘如何运作。了解磁盘擅长什么以及哪些操作成本 更高，有助于构建分配策略。

## 6.3 物理磁盘

物理磁盘是一个复杂的机械装置，包含许多部分（参见第3章的图3-1）。 出于我们讨论的目的，我们只需要了解磁盘的三个部分：盘片、磁道和磁头。 每个磁盘都由一组盘片组成。盘片薄、圆形且呈金属状。现代磁盘使用直径 在2-5英寸之间的盘片。盘片有两面，每一面都划分成磁道。磁道是围绕盘片 的窄圆形环。任何特定的磁道与盘片中心的距离总是相同的。每个盘片每面 通常有2000到5000个磁道。每个磁道又划分成扇区（或磁盘块）。扇区是 磁盘驱动器可以读取或写入的最小不可分割单位。一个扇区通常大小为512字节。

每个盘片有两个磁头，一个用于上面，一个用于下面。所有磁头都连接在 同一个磁臂上，并且所有磁头都对齐。通常，每个磁头下的所有磁道被统称为 一个柱面或柱面组。所有磁头同时访问每个盘片上的同一磁道。虽然这很有趣， 但某些磁头读取一个磁道而其他磁头读取不同磁道是不可能的。

在同一个柱面内执行I/O非常快，因为它几乎不需要磁头移动。在同一个柱面内 从一个磁头切换到另一个磁头比重新定位到不同的磁道要快得多，因为只需要 对磁头位置进行微小调整即可从不同磁头上的同一磁道读取数据。

从一个磁道移动到另一个磁道涉及到所谓的寻道。跨磁道寻道需要磁臂在 磁盘上的物理移动，从一个位置到另一个位置。将磁臂重新定位到新磁道需要 将新位置的精度控制在0.05-0.1毫米以内。找到位置后，磁臂和磁头必须稳定下来 才能进行I/O。寻道中移动的距离也会影响完成寻道所需的时间。寻道到相邻磁道 所需的时间少于从最内层磁道寻道到最外层磁道所需的时间。在进行I/O之前， 从一个磁道寻道到另一个磁道所需的时间称为寻道时间。寻道时间通常为5-20毫秒。 这可能是现代计算机系统中最慢的操作。

尽管前面几段讨论了磁盘驱动器非常底层的几何结构，但大多数现代磁盘 驱动器都竭力向用户隐藏这些信息。即使操作系统提取了物理几何信息，驱动器 也很可能为了自身的需求而伪造了信息。磁盘驱动器这样做是为了能够以对 特定驱动器最优化方式将逻辑磁盘块地址映射到物理位置。在磁盘驱动器内部 执行映射允许制造商利用对驱动器的深入了解；如果宿主系统试图利用驱动器的 物理知识来优化访问模式，它只能以一种通用的方式进行。

尽管磁盘驱动器在隐藏物理几何结构方面做了很多工作，但理解不同类型 操作所涉及的延迟问题会影响文件系统分配策略的设计。构建分配策略时另一个 重要考虑因素是了解磁盘擅长什么。任何磁盘能执行的最快操作是读取连续的 数据块。顺序I/O之所以快，是因为它最容易实现快速。对大型连续内存块的I/O 允许操作系统利用DMA（直接内存访问）和突发总线传输。此外，在磁盘驱动器 层面，大型传输利用了任何板载缓存，并允许驱动器充分利用其块重映射功能， 从而减少将数据传输到/从盘片所需的时间。

一个简单的测试程序有助于说明一些相关问题。测试程序打开一个裸设备， 生成一个随机的块地址列表（1024个），然后计时读取该随机列表的块所需的时间， 与将它们按排序顺序读取所需的时间进行比较。在BeOS系统上使用几种不同的 磁盘驱动器（Quantum、Seagate等）时，我们发现按排序顺序读取1024个块与 按随机顺序读取所需的时间差接近两倍。也就是说，仅仅对块列表进行排序就 将读取所有块所需的时间从16秒减少到大约8.5秒。为了说明随机I/O和顺序I/O 之间的差异，我们还让程序通过一次读取操作读取相同总量的数据（512K）。 该操作花费了不到0.2秒完成。尽管绝对数字会因测试使用的硬件配置而异，但 这些数字的重要性在于它们之间的相对关系。差异是惊人的：大型连续数据块 的顺序I/O比甚至排序的I/O列表快近50倍，比纯随机顺序读取相同量的数据快近100倍。

从这些数据中可以得出两个重要的结论：连续I/O是磁盘可以执行的最快操作， 至少快一个数量级。了解顺序I/O和随机I/O之间速度的巨大差异，我们可以看到， 以牺牲数据局部性为代价来试图紧凑数据结构是没有意义的。读取一个大型连续 数据结构要快得多，即使它的大小是更紧凑但分散的数据结构的10倍。这相当反直觉。

另一个显著的结论是，当I/O必须在许多不同位置进行时，批量处理多个事务 是明智的。通过将操作批量处理并对生成的块地址列表进行排序后再执行I/O， 文件系统可以利用不同操作之间的任何局部性，并将磁盘寻道成本分摊到许多 操作上。这种技术可以将执行I/O所需的时间减半。
