---
typora-root-url: ./..\..\public\
---

# 文件系统性能

衡量和分析文件系统性能是编写文件系统的一个重要组成部分。如果没有一些衡量文件系统实现的指标，就没有办法评估其质量。我们可以通过其他一些指标来判断文件系统——例如，可靠性——但我们假设，在考虑性能之前，可靠性必须是前提。衡量性能对于理解应用程序的表现以及文件系统能够处理的工作负载类型很有用。

## 9.1 什么是性能？

文件系统的性能有许多不同的方面。衡量文件系统的性能有许多不同的方法，这是一个活跃的研究领域。事实上，甚至没有一个与 CPU 的 SPEC 基准测试相对应的常用磁盘基准测试。不幸的是，似乎每当一个新的文件系统被编写出来，新的基准测试也会随之被编写出来。这使得比较文件系统变得非常困难。

有三个主要的文件系统衡量类别是值得关注的：

- 吞吐量基准测试（每秒兆字节的数据传输量）
- 元数据密集型基准测试（每秒操作数）
- 真实世界工作负载（吞吐量或每秒事务数）

吞吐量基准测试衡量文件系统在各种条件下每秒可以提供多少兆字节的数据传输量。最简单的情况是文件的顺序读写。使用多线程、不同文件大小和文件数量也可以进行更复杂的吞吐量测量。吞吐量测量非常依赖于所使用的磁盘，因此，绝对测量虽然有用，但在不同系统之间进行比较很困难，除非使用相同的硬盘。一个更有用的衡量标准是文件系统达到的原始磁盘带宽的百分比。也就是说，直接对磁盘设备执行大的顺序 I/O 会产生一定的数据传输速率。将文件系统顺序 I/O 的吞吐量作为原始磁盘带宽的百分比来衡量，可以得到一个更容易比较的数字，因为这个百分比实际上是一个归一化数字。传输速率非常接近原始驱动器传输速率的文件系统是理想的。

元数据密集型基准测试衡量文件系统每秒可以执行的操作数量。文件系统执行的主要元数据密集型操作是打开、创建、删除和重命名。在这些操作中，重命名通常不被视为性能瓶颈，因此很少被关注。其他操作会显著影响使用文件系统的应用程序的性能。每秒的操作数越高，文件系统的性能越好。

真实世界基准测试利用文件系统来执行一些任务，例如处理电子邮件或互联网新闻、从存档中提取文件、编译大型软件系统或复制文件。除了文件系统本身之外，许多不同的因素会影响真实世界基准测试的结果。例如，如果虚拟内存系统和磁盘缓冲区缓存集成在一起，系统可以更有效地利用内存作为磁盘缓存，从而提高性能。尽管统一的 VM 和缓冲区缓存可以提高大多数与磁盘相关的测试的性能，但这与文件系统的质量（或不足）无关。尽管如此，真实世界基准测试很好地表明了一个系统执行特定任务的能力。关注真实世界任务的性能很重要，这样系统才不会被优化成只运行特定的合成基准测试。

## 9.2 哪些是基准测试？

有大量的的文件系统基准测试可用，但我们偏向于测量文件系统性能特定领域的简单基准测试。简单的基准测试易于理解和分析。在 BFS 的开发过程中，我们只使用了少数基准测试。使用的两个主要测试是 IOZone 和 lat_fs。

IOZone 由 Bill Norcott 编写，是一个直接的吞吐量测量测试。IOZone 使用命令行上指定的 I/O 块大小顺序写入文件，然后顺序读回文件。文件的大小也在命令行上指定。通过调整 I/O 块大小和总文件大小，可以轻松调整 IOZone 的行为，以反映许多不同类型的顺序文件 I/O。幸运的是，顺序 I/O 是程序执行的主要 I/O 类型。此外，我们预计 BeOS 将用于向磁盘传输大量数据（以大型音频和视频文件的形式），因此 IOZone 是一个很好的测试。

第二个测试 lat_fs 是 Larry McVoy 的 lmbench 测试套件的一部分。lat_fs 首先创建 1000 个文件，然后删除它们。lat_fs 测试对文件大小为 0 字节、1K、4K 和 10K 的文件执行此操作。基准测试的结果是文件系统对于每种文件大小每秒可以创建和删除的文件数量。尽管它极其简单，但 lat_fs 测试是一种衡量文件系统最重要的两个元数据密集型操作的直接方法。lat_fs 测试的唯一缺点是它只创建固定数量的文件。为了观察更大数量文件的行为，我们编写了一个类似的程序，在一个目录中创建和删除任意数量的文件。

除了使用这两个测量外，我们还运行了几个真实世界的测试，试图客观地了解文件系统在常见任务中的速度。第一个真实世界测试只是简单地计时大型（10-20 MB）存档的打包和解包。这很好地衡量了文件系统处理实际文件大小（而不是所有文件大小固定）时的表现，并且数据集足够大，不会完全放入缓存中。

第二个真实世界测试只是编译一个源代码库。它不一定是磁盘密集度最高的操作，但由于许多源代码文件都很小，它们会花费大量时间打开许多头文件，因此涉及相当数量的文件系统操作。当然，我们在选择这个基准测试时确实有一些偏见，因为提高它的速度直接影响我们的日常工作（包括编译大量代码）！

其他真实世界测试仅仅是运行涉及大量磁盘 I/O 的实际应用程序并观察它们的性能。例如，一个在 BeOS 上运行的面向对象数据库软件包有一个基准测试模式，可以计时各种操作。视频捕获等其他应用程序也很好地作为应用程序行为的真实示例。并非所有真实世界测试都能得出具体的性能数字，但它们能否成功运行直接衡量了文件系统的质量。

### 其他基准测试

如前所述，还有相当多的其他文件系统基准测试程序。最值得注意的是：

- Andrew 文件系统基准测试 (Andrew File System Benchmark)
- Bonnie
- IOStone
- SPEC SFS
- Chen 的自适应缩放基准测试 (Chen’s self-scaling benchmark)
- PostMark

前三个基准测试（Andrew、Bonnie 和 IOStone）不再是特别有趣的基准测试，因为它们通常完全适合文件系统缓冲区缓存。Andrew 基准测试的工作集很小，主要由编译大量源代码构成。尽管我们认为编译代码是一个有用的衡量标准，但如果 Andrew 基准测试只能告诉我们这些，那么投入精力移植它几乎不值得。

Bonnie 和 IOStone 的工作集非常小，很容易适合大多数文件系统缓冲区缓存。这意味着 Bonnie 和 IOStone 最终测量的是从缓冲区缓存到用户空间的 `memcpy()` 速度——这是一个有用的测量，但与文件系统关系不大。

SPEC SFS 基准测试（以前称为 LADDIS）旨在测量网络文件系统（NFS）服务器的性能。这是一个有趣的基准测试，但您必须是 SPEC 组织的成员才能获得它。此外，由于它旨在测试 NFS，因此需要 NFS 和多个客户端。SPEC SFS 基准测试并非真正针对独立的 文件系统，也不是一个容易运行的基准测试。

Chen 的自适应缩放基准测试解决了 Andrew、Bonnie 和 IOStone 基准测试中存在的一些问题。通过调整基准测试参数以适应被测系统，该基准测试能更好地适应不同的系统，并避免了静态大小的参数最终变得过小的问题。基准测试的自适应缩放使得无法在不同系统之间比较结果。为了解决这个问题，Chen 使用“预测性能”来计算一个可以与其他系统比较的系统性能曲线。不幸的是，预测性能曲线仅以每秒兆字节表示，对于指示系统哪些领域需要改进作用不大。Chen 的自适应缩放基准测试是一个很好的通用测试，但对于我们的需求来说不够具体。

最近加入基准测试阵营的是 PostMark。PostMark 测试由 Network Appliance（一家 NFS 服务器制造商）编写，试图模拟大型电子邮件系统的工作负载。该测试创建一组初始工作文件，然后执行一系列事务。这些事务包括读取文件、创建新文件、向现有文件追加数据和删除文件。测试的所有参数都可以配置（文件数量、事务数量、读/写数据量、读/写百分比等）。这个基准测试会得出三个性能数字：每秒事务数、有效读取带宽和有效写入带宽。默认参数使得 PostMark 成为一个非常好的小文件基准测试。通过调整参数，PostMark 可以模拟各种工作负载。PostMark 的另外两个关键特性是源代码可以免费下载，并且可以移植到 Windows 95 和 Windows NT。能够移植到 Windows 95 和 Windows NT 非常重要，因为这两个操作系统很少受到专注于 Unix 的研究社区的关注。很少有（如果有的话）其他基准测试可以在 POSIX 和 Win32 API 下不经修改地运行。能够在各种系统（不仅仅是 Unix 衍生系统）之间直接比较 PostMark 的性能数字很有用。遗憾的是，PostMark 于 1997 年 8 月才发布，因此对 BFS 的设计没有产生影响。

### 基准测试的危险

运行任何一套基准测试的最大陷阱是它会迅速演变成一场在特定基准测试上击败所有其他文件系统的竞赛。除非所讨论的基准测试是重要客户应用程序的真实世界测试，否则为特定基准测试优化文件系统不太可能有助于提高整体性能。事实上，很可能发生恰恰相反的情况。

在 BFS 的开发过程中，有一段时间，lat_fs 基准测试成为了性能改进的唯一重点。通过各种技巧，lat_fs 的性能得到了显著提高。不幸的是，同样的更改却降低了其他更常见的操作的速度（例如解压文件存档）。这显然不是理想的情况。

基准测试的危险在于，很容易只关注一个性能指标。除非这个指标是唯一关注的指标，否则只关注一个基准测试很少是一个好主意。运行各种测试，特别是真实世界的测试，是防止进行仅适用于单个基准测试的优化的最佳保护。

### 运行基准测试

文件系统的基准测试几乎总是在新创建的文件系统上运行。这确保了最佳性能，这也意味着基准测试数字可能有点误导。然而，很难准确地“老化”文件系统，因为没有标准化的方法来老化文件系统，使其看起来像经过一段时间使用后那样。尽管不能呈现全貌，但在干净的文件系统上运行基准测试是比较文件系统性能数字的最安全方式。

通过在运行基准测试之前，让系统进行一组明确定义的文件系统活动，可以获得更完整的文件系统性能图景。这是一项困难的任务，因为任何特定的文件系统活动集很可能只代表一种工作负载。由于准确地老化文件系统并针对各种工作负载进行操作存在困难，因此通常不这样做。这并不是说老化文件系统不可能，但除非准确、可重复且一致地完成，否则报告老化文件系统的文件系统基准测试将是不准确且具有误导性的。
