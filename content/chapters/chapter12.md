---
typora-root-url: ./..\..\public
---



# 测试 (Testing)

软件测试通常是随意进行的，是事后才想到的，主要是为了确保没有明显的错误。然而，文件系统是系统软件的关键组成部分，用户必须绝对依赖它来安全可靠地存储数据。作为计算机系统永久数据的主要存储库，文件系统必须承担 **100%可靠性**的重担。文件系统的测试必须彻底且极其严格。未经深思熟虑或细心测试的文件系统很可能不可靠。

不可能发布规定测试应该如何进行的指令，也不是本章的重点。相反，其目的是介绍**如何对文件系统进行压力测试**，以便在系统发布之前尽可能多地发现错误。

## 12.1 辅助措施 (The Supporting Cast)

在设计测试计划和编写测试之前，文件系统应该以**永远不损坏用户数据**为目标来编写。在实践中，这意味着几件事：

- **充分利用运行时一致性检查**。相对于磁盘访问的成本，它们是廉价的，因此基本上是免费的。
- 在使用数据结构之前**验证其正确性**有助于及早发现问题。
- 检测到损坏时**停止系统**比不检查继续运行更好。
- 添加有用的**调试消息**和编写好的**调试工具**在诊断问题时可以节省大量时间。

出于性能原因，生产代码中的数据结构运行时检查通常会被禁用。幸运的是，在文件系统中，磁盘访问的成本远远超过 CPU 时间，因此即使在生产系统中禁用运行时检查也是愚蠢的。实际上，BFS 在启用或禁用运行时检查时，性能差异可以忽略不计。好处是，即使在生产系统中，你也可以合理地确信，如果发生意外错误，系统会检测到它并通过停止系统来防止损坏。

在 BFS 中，在使用数据结构之前验证其正确性被证明是**无价的调试辅助**。例如，在每个文件系统入口点，任何传入的 i-node 数据结构在使用前都会经过验证。i-node 数据结构对于系统的正确运行至关重要。因此，一个简单的宏或函数调用来验证 i-node 是极其有用的。例如，在 BFS 中，`CHECK_INODE()` 宏验证 i-node 魔数、文件大小、i-node 大小以及与 i-node 关联的内存中指针。在 BFS 的开发过程中，这种检查多次捕获并防止了由于野指针引起的磁盘损坏。然后停止系统允许使用调试器进行更仔细的检查，以确定发生了什么。

## 12.2 数据结构验证示例 (Examples of Data Structure Verification)

BFS 使用一个名为**数据流**的数据结构来枚举哪些磁盘块属于文件。数据流结构使用**扩展区 (extents)** 来描述属于文件的块运行。间接块和双间接块具有略微不同的约束，这在操作数据流结构时导致了很大的复杂性。数据流结构是存储用户数据最关键的结构。如果数据流引用了不正确的磁盘位置或不正确地访问了磁盘的某个部分，那么用户数据就会损坏。文件系统会对数据流结构执行大量检查以确保其正确性：

- 当前文件位置是否超出范围？
- 当前文件位置是否有有效的文件块？
- 分配给文件大小的块是否太少？
- 文件中间的块是否意外地空闲？

每次对文件的访问都会将当前文件位置转换为磁盘块地址。上述大部分检查都在执行从文件位置到磁盘块地址转换的例程中执行。文件的双间接块会收到额外的一组一致性检查，因为它们受到额外的约束（每个扩展区都是固定大小等）。在更改文件大小时（无论是增长还是缩小），还会对数据流结构进行进一步检查。

除了上述一致性检查之外，操作数据流结构的代码还必须对其他 BFS 函数的结果进行**错误检查**。例如，在文件增长时，会**健全性检查**块分配函数返回的块号，以确保系统其他部分的错误不会造成损害。这种**防御性编程**风格可能看起来不必要，但交叉检查其他模块的正确性有助于确保系统某个部分的错误不会导致另一个模块崩溃或写入磁盘上的不正确位置。

BFS 还在大量情况下检查**不可能发生的情况**。不可能发生的情况是那些不应该发生但总是会发生的情况。例如，在文件数据流中定位数据块时，可能会遇到一个指向零块而不是有效块号的块运行。如果文件系统没有检查这种情况（这当然永远不应该发生），它可能会允许程序覆盖文件系统超级块，从而破坏关键的文件系统信息。如果未进行检查并且超级块被覆盖，则很可能在损坏发生很久之后才检测到错误。不可能发生的情况几乎总是在调试系统时出现，因此即使看起来不太可能，检查它们也总是有益的。

当文件系统检测到不一致状态时，最好简单地**停止文件系统**，或者至少停止特定的执行线程。BFS 通过进入一个打印恐慌消息然后无限循环的例程来实现这一点。停止系统（或至少停止特定的执行线程）允许程序员进入调试器并检查系统的状态。在生产环境中，这通常会导致系统锁定，虽然这相当不可接受，但它优于损坏的硬盘。

## 12.3 调试工具 (Debugging Tools)

文件系统的早期开发可以在用户级别完成，通过构建一个测试工具，将文件系统的核心功能与一组简单的 API 调用连接起来，供测试程序调用。开发测试环境允许文件系统开发者使用**源代码级调试工具**来使基本功能正常工作并快速原型化设计。在用户级别调试文件系统比典型的内核开发周期（涉及崩溃后重启，并且通常不提供用户级源代码调试的奢侈）要好得多。

尽管每个系统的调试环境都有其独特之处，但几乎总有一个基本的功能级别。最基本的调试功能是**转储内存**和获取**堆栈回溯**的能力，堆栈回溯显示了在当前状态之前调用了哪些函数。

BeOS 内核的调试环境基于一个**原始的内核监视器**，可以通过特殊的击键或特殊的不可屏蔽中断 (NMI) 按钮进入。一旦进入监视器，程序员可以检查系统状态并通常进行探查。这个监视器环境支持**动态添加调试器命令**。文件系统向监视器添加了许多命令，以易于阅读的格式（而不是原始十六进制转储）打印各种文件系统数据结构。

良好调试工具的重要性怎么强调都不为过。在 BFS 的开发过程中，测试中多次出现错误，能够输入几个命令来检查各种结构的状态，这使得查找错误——或至少诊断问题——**变得容易得多**。（尽管这种情况仍然发生，但如果没有这些工具，情况可能会糟糕得多）。

文件系统调试命令总共有 18 个函数，其中 7 个至关重要。最重要的命令是：

- 转储超级块
- 转储 i-node
- 转储数据流
- 转储 i-node 的嵌入属性
- 在缓存中查找块（通过内存地址或块号）
- 列出线程的打开文件句柄
- 在所有打开的文件中查找 vnode-id

这套工具使得快速检查最重要的数据结构成为可能。如果 i-node 损坏，快速转储结构会显示哪些字段已损坏，通常再执行几个命令就会揭示损坏是如何发生的。
