---
typora-root-url: ./..\..\public
---

# BFS的数据结构

## 4.1 什么是磁盘？

BFS（Be File System）将磁盘视为一个线性块数组，并在此基础抽象之上管理其所有数据结构。最底层，原始设备（如 SCSI 或 IDE 磁盘）都有一个设备块大小的概念，通常为 512 字节。BFS 中的“块”概念建立在原始设备块之上。文件系统块大小与原始设备块大小只有松散的耦合关系。对文件系统块大小的唯一限制是它必须是底层设备块大小的整数倍。也就是说，如果原始设备块大小是 512 字节，那么文件系统块大小可以是 512、1024 或 2048 字节。尽管也可以使用 1536 字节（3×512）这样的块大小，但由于它不是 2 的幂，这在性能上是非常糟糕的选择。虽然并非严格要求，但使用非 2 的幂块大小会对性能产生显著影响。

文件系统块大小还会影响虚拟内存系统（如果系统支持内存映射文件的话）。此外，如果希望将虚拟内存系统与缓冲缓存（buffer cache）统一起来，使文件系统块大小为 2 的幂是必需的（理想情况下，VM 页大小与文件系统块大小相等）。BFS 允许的块大小为 1024、2048、4096 或 8192 字节。我们不允许 512 字节块大小，是因为这样会导致某些关键的文件系统数据结构跨越多个块，给缓存管理和日志（journaling）带来复杂性，也会引起明显的性能下降。至于为什么最大块大小限定为 8192 字节，则需要先理解后面提到的其他结构，届时再作解释。

重要的是要认识到，文件系统块大小与磁盘容量无关（这点不同于 Macintosh HFS）。文件系统块大小的选择应根据磁盘上要存储的文件类型来决定：大量小文件在 8K 块下会造成大量空间浪费；而对于包含大文件的文件系统，则更适合使用更大的块，而非非常小的块。

## 4.2 如何管理磁盘块

管理磁盘空闲空间的方法有多种，最常见且最简单的是位图（bitmap）方案。其他方法有基于 extent 的和基于 B+ 树的（如 XFS）。BFS 出于简洁考虑，采用了位图方案。

位图方案将每个磁盘块表示为一个比特，文件系统将整个磁盘视为这些比特的数组。如果某个比特为 1，则对应磁盘块已被分配。计算位图所需空间（字节）的公式为：

```c
(disk size in bytes) / (filesystem block size × 8)
```

例如，对于一个 1 GB、块大小为 1 KB 的磁盘，其位图大小为 128 KB。

位图方案的主要缺点是，要寻找大块连续的空闲空间时，需要线性扫描整个位图。还有人认为，随着磁盘的逐渐填满，位图扫描的成本会增加；但实际上可以证明，查找位图中一个空闲比特的平均成本与位图的填充程度无关。正是因为这一点，加之实现简单，BFS 才使用了位图方案（尽管事后我也希望有时间去尝试其他分配方案）。

位图数据结构在磁盘上以一个连续的字节数组存储（向上取整至块大小的整数倍）。BFS 从块 1 开始存放位图（超级块 superblock 占据块 0）。在创建文件系统时，超级块和位图所占用的块会预先分配好。

## 4.3 分配组（Allocation Groups）

分配组是纯逻辑结构，没有对应的实际结构体。BFS 将构成文件系统的块数组划分为若干等大区块，称为“分配组”。分配组的概念用于将数据分散存放在磁盘上。

一个分配组就是磁盘上若干连续的块。分配组中块的数量与文件系统块大小及整个磁盘的位图大小密切相关。为了效率和方便，BFS 强制每个分配组的块数为一个位图块所映射块数的整数倍。以一个 1 GB、块大小为 1 KB 的磁盘为例，该磁盘的位图大小为 128 KB，因此占用 128 块。由于每个位图块为 1 KB，可映射 8192 块，故最小分配组大小为 8192 块。由于设计上的其它考量，最大分配组大小始终为 65 536 块。BFS 在选择分配组大小时，会在磁盘容量（对大分配组的需求）与分配组数量（不宜过多）之间进行平衡；实践中，通常用每 GB 空间约 8192 块作为分配组大小的经验值。

如前所述，BFS 使用分配组来分散数据存放。BFS 会尝试将文件的控制信息（i-node）放在与其父目录相同的分配组内；同时，BFS 会尝试将新创建的目录放在与包含它的目录不同的分配组中，文件数据也会放在与其控制信息不同的分配组。这样的布局策略倾向于将同一目录下的文件控制信息聚集在一个分配组，而将文件数据聚集在另一个分配组，从而使同一目录下的文件物理上靠得更近。需要注意的是，这只是一个建议策略；如果磁盘已接近满，唯一可用的空闲空间正好在同一分配组内，BFS 仍会进行分配。

为了提升分配块时的性能，BFS 在内存中维护了每个分配组在位图中的信息。每个分配组都记录了上次分配的空闲块索引，以便下次分配时无需从组开始处线性扫描；此外，还为每个分配组维护了“已满”标志，以便在分配组已无可用空间时，直接跳过对该组位图的扫描。

## 4.4 块运行（Block Runs）

块运行结构是 BFS 定位磁盘块的基本方式。其定义如下：

```c
typedef struct block_run {
    int32  allocation_group;
    uint16 start;
    uint16 len;
} block_run;
```

* `allocation_group` 字段指出所在的分配组；
* `start` 字段指出在该分配组内块运行的起始块号；
* `len` 字段指出该运行包含的块数。

该结构能表示的最大块号为 2^48（当块大小为 1 KB 时，对应最大磁盘容量约 2^58 字节）；尽管相比纯 64 位块号略显不足，但 2^58 字节的容量足以存储 217 年的 720×486 分辨率、4 字节/像素、30 帧/秒的未压缩视频，用量远超过可预见的需求。

`len` 字段为 16 位，最多可表示 65 536 块。对文件系统块大小较大时，单个 8 字节的块运行寻址最多可达数十 MB，已相当实用。但 `start` 字段也是 16 位无符号数，这意味着单个分配组最多 65 536 块，进而使得 8192 字节成为 BFS 文件系统块大小的上限：若允许更大块，位图每块映射更多块，分配组将超出 `start` 字段的可寻址范围，导致部分块无法分配。

BFS 将块运行结构用作 i-node 的寻址结构；在 i-node 寻址时，`len` 字段始终为 1。
